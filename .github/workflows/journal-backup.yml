name: Journal Daily Backup

on:
  schedule:
    # Run daily at 2:00 AM UTC (7:30 AM IST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci || npm install

      - name: Install Backup Dependencies
        run: npm install -g tsx firebase-admin

      - name: Run Backup Script
        env:
          # Firebase Admin (Service Account)
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

          # Cloudflare D1
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}

          # Turso
          TURSO_URL: ${{ secrets.TURSO_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}

          # Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

          # Neon
          NEON_CONNECTION_STRING: ${{ secrets.NEON_CONNECTION_STRING }}

          # Xata
          XATA_API_KEY: ${{ secrets.XATA_API_KEY }}
          XATA_DB_URL: ${{ secrets.XATA_DB_URL }}

          # CockroachDB
          COCKROACH_CONNECTION_STRING: ${{ secrets.COCKROACH_CONNECTION_STRING }}

          # Oracle Cloud
          ORACLE_REST_URL: ${{ secrets.ORACLE_REST_URL }}
          ORACLE_AUTH_TOKEN: ${{ secrets.ORACLE_AUTH_TOKEN }}

          # MongoDB Atlas
          MONGODB_DATA_API_URL: ${{ secrets.MONGODB_DATA_API_URL }}
          MONGODB_API_KEY: ${{ secrets.MONGODB_API_KEY }}

          # AWS DynamoDB
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          DYNAMODB_TABLE: ${{ secrets.DYNAMODB_TABLE }}

          # Appwrite
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
          APPWRITE_DB_ID: ${{ secrets.APPWRITE_DB_ID }}
          APPWRITE_COLLECTION_ID: ${{ secrets.APPWRITE_COLLECTION_ID }}

          # GitHub
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_BACKUP_REPO: 'chirag127/me'
        run: npx tsx scripts/backup-journal.ts

      - name: Commit Backup JSON (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/journal-backup.json 2>/dev/null || true
          git diff --staged --quiet || git commit -m "chore: daily journal backup [$(date +%Y-%m-%d)]"
          git push || true
